{% extends "base.html" %}
{% block title %}Project Status{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/vis/vis-timeline-graph2d.min.css') }}">
<style>
  /* Layout */
  #timeline-wrapper{display:flex;flex-direction:column;height:calc(100vh - 160px)}
  #timeline{width:100%;flex:1;border:1px solid #dee2e6;border-radius:.5rem}

  /* Filters: project list NGANG + scroll */
  #timeline-filters{padding-bottom:.5rem;display:flex;align-items:center;gap:.75rem}
  #timeline-filters strong{white-space:nowrap}
  #timeline-filters .list-group{display:flex;flex-direction: row; gap: 0.5rem; }
  #timeline-filters .list-group::-webkit-scrollbar{height:6px}
  #timeline-filters .list-group::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
  #timeline-filters .list-group::-webkit-scrollbar-track{background:transparent}
  #timeline-filters .list-group-item{padding:.375rem .75rem;border-radius:.375rem;cursor:grab;border:1px solid #dee2e6;background:#fff;transition:.2s;flex:0 0 auto}
  #timeline-filters .list-group-item.active{background:#0d6efd;color:#fff;border-color:#0d6efd}
  #timeline-filters .list-group-item.all-btn{cursor:default}

  /* Timeline cosmetics */
  .vis-time-axis.vis-foreground{height:60px!important}
  .vis-time-axis .vis-text.vis-major{font-size:18px;font-weight:700}
  .vis-time-axis .vis-text.vis-minor{font-size:14px}
  .vis-labelset .vis-label{width:80px!important;font-weight:700;font-size:15px;color:#343a40;display:flex;align-items:center;padding-left:1.25rem}

  /* === Kiểu THẺ + MŨI TÊN === */
  .vis-item.phase{height:54px;border:none!important;background:transparent;box-shadow:none}
  .vis-item.phase.hide-dates {
      height: 36px;
  }
  .vis-item.phase .vis-item-content{
    width:100%;height:100%;
    background:var(--phase-color,#dbeafe);
    border:1px solid rgba(0,0,0,.08);
    /* MŨI TÊN bên phải */
    clip-path:polygon(0% 0%,calc(100% - 18px) 0%,100% 50%,calc(100% - 12px) 100%,0% 100%,12px 50%);
    display:flex;flex-direction:column;justify-content:center;
    padding:6px 28px 6px 22px
  }
  .vis-item .phase-label{font-weight:700;font-size:15px;line-height:1.25;color:var(--text-color,#0f172a)}
  .vis-item .phase-dates{font-size:12px;line-height:1.2;color:var(--date-color,#334155);opacity:.95;margin-top:2px}

  /* Bảng màu tham khảo */
  .phase-p1  {--phase-color:#f8d7da;--text-color:#58151c;--date-color:#7c5431}
  .phase-p2  {--phase-color:#d1ecf1;--text-color:#0c5460;--date-color:#2a7886}
  .phase-e1  {--phase-color:#d4edda;--text-color:#155724;--date-color:#2b7a4b}
  .phase-e2  {--phase-color:#cdeec9;--text-color:#155724;--date-color:#2b7a4b}
  .phase-d1  {--phase-color:#e2d9f3;--text-color:#493267;--date-color:#5b4573}
  .phase-pvt {--phase-color:#28a745;--text-color:#fff;--date-color:#e0ffe0}
  .phase-poc,.phase-c1,.phase-c2,.phase-c3{--phase-color:#dae0e5;--text-color:#383d41;--date-color:#5a6268}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-0">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h2 class="m-0">Models Status</h2>
    <div class="d-flex align-items-center gap-2" role="group">
        <div class="btn-group" role="group">
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal"><i class="fa-solid fa-plus me-2"></i>New Project</button>
            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#addBuildModal"><i class="fa-solid fa-plus me-2"></i>New Build</button>
        </div>

        <div class="btn-group" role="group">
            <button id="viewDayBtn" class="btn btn-outline-secondary btn-sm">Day</button>
            <button id="viewWeekBtn" class="btn btn-outline-secondary btn-sm active">Week</button>
            <button id="viewMonthBtn" class="btn btn-outline-secondary btn-sm">Month</button>
        </div>
        <a href="{{ url_for('main.manual_timeline') }}" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-arrow-right"></i> Manual Timeline</a>
        
      <button id="zoomOutBtn" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
      <button id="zoomInBtn"  class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
      <button id="todayBtn"   class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-calendar-day"></i> Today</button>
      <button id="fitBtn"     class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-expand"></i> Fit</button>
    </div>
  </div>

  <div id="timeline-wrapper">
    <div id="timeline-filters">
      <strong>Projects:</strong>
      <div class="list-group" id="model-filter-buttons" aria-label="Projects list (horizontal scroll)"></div>
        <div class="form-check form-switch ms-auto">
            <input class="form-check-input" type="checkbox" id="showDatesCheckbox">
            <label class="form-check-label" for="showDatesCheckbox">Show Dates</label>
        </div>
    </div>
    <div id="timeline"></div>
  </div>
</div>

{% include 'partials/_project_modals.html' %}
{% include 'partials/_task_modal.html' %}

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/vis/vis-timeline-graph2d.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/sortablejs/Sortable.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
<script src="{{ url_for('static', filename='js/okr.js') }}"></script>
<script>
// Drag + Filter + TRUE FIT + PERSIST FILTER (lưu trạng thái cuối cùng)

document.addEventListener('DOMContentLoaded', async () => {
  // =================================================================
  // ===== BẮT ĐẦU ĐOẠN CODE SỬA LỖI CHO NÚT DELETE ===================
  // =================================================================
  
  // 1. Sửa lỗi cho Modal "Edit Project"
  const editProjectModal = document.getElementById('editProjectModal');
  if (editProjectModal) {
      const deleteProjectForm = document.getElementById('deleteProjectForm');
      const editProjectForm = document.getElementById('editProjectForm');

      editProjectModal.addEventListener('show.bs.modal', function (event) {
          const button = event.relatedTarget;
          const projectId = button.getAttribute('data-id');

          if (projectId) {
              // Cập nhật action cho cả form Edit và form Delete
              editProjectForm.action = `/update-project/${projectId}`;
              deleteProjectForm.action = `/delete-project/${projectId}`;
          }
      });
  }

  // 2. Sửa lỗi cho Modal "Edit Build"
  const editBuildModal = document.getElementById('editBuildModal');
  if (editBuildModal) {
      const deleteBuildForm = document.getElementById('deleteBuildForm');
      const editBuildForm = document.getElementById('editBuildForm');

      editBuildModal.addEventListener('show.bs.modal', function (event) {
          const button = event.relatedTarget;
          const buildId = button.getAttribute('data-id'); 

          if (buildId) {
            // Cập nhật action cho cả form Edit và form Delete
            editBuildForm.action = `/update-build/${buildId}`;
            deleteBuildForm.action = `/delete-build/${buildId}`;
          }
      });
  }

  // =================================================================
  // ===== KẾT THÚC ĐOẠN CODE SỬA LỖI ================================
  // =================================================================

  const container = document.getElementById('timeline');
  const filterContainer = document.getElementById('model-filter-buttons');
  const LS_ORDER_KEY  = 'roadmapProjectOrder';
  const LS_FILTER_KEY = 'roadmapActiveFilters';
  const showDatesCheckbox = document.getElementById('showDatesCheckbox');

  // --- Load data ---
  let payload = { success:false, groups:[], items:[] };
  try {
    const resp = await fetch('{{ url_for("main.vis_roadmap_data") }}');
    if (!resp.ok) throw new Error(`Server responded with ${resp.status}`);
    payload = await resp.json();
	if (!payload.success || !Array.isArray(payload.items) || payload.items.length === 0) {
	  container.innerHTML = `
		<div class="alert alert-info mb-0">
		  Chưa có dự án nào để hiển thị. Nhấn <b>New Project</b> để tạo trước nhé.
		</div>`;
	  // (tuỳ chọn) disable các nút điều khiển để khỏi bấm nhầm
	  ['fitBtn','zoomInBtn','zoomOutBtn','todayBtn','viewDayBtn','viewWeekBtn','viewMonthBtn']
		.forEach(id => { const el = document.getElementById(id); if (el) el.disabled = true; });
	  return; // dừng ở đây, không khởi tạo timeline
	}

  } catch (e) {
    container.innerHTML = `<div class="alert alert-danger">Failed to load data: ${e.message}</div>`;
    return;
  }
  if (!payload.success || !payload.items || payload.items.length === 0) {
    container.innerHTML = `<div class="alert alert-warning">No roadmap data available.</div>`;
    return;
  }

  // --- Prepare groups with saved order ---
  let groupsFromServer = (payload.groups || []).map((g, idx) => ({...g, order: idx}));
  try {
    const saved = JSON.parse(localStorage.getItem(LS_ORDER_KEY));
    if (Array.isArray(saved) && saved.length) {
      const m = new Map(saved.map((id, i) => [String(id), i]));
      groupsFromServer.sort((a,b) => (m.get(String(a.id)) ?? 1e9) - (m.get(String(b.id)) ?? 1e9));
      groupsFromServer = groupsFromServer.map((g, i) => ({...g, order: i}));
    }
  } catch(_){}

  const groups = new vis.DataSet(groupsFromServer);
  
  // --- Create item content based on showDates state ---
  const createItemContent = (itemData) => {
    const showDates = showDatesCheckbox.checked;
    
    let label = itemData.content || '';
    let content = `<div class="phase-label">${label}</div>`;
    if (showDates && itemData.start && itemData.end) {
        const startDateStr = itemData.start ? new Date(itemData.start).toLocaleDateString('en-GB', { month: 'numeric', day: 'numeric' }) : '';
        const endDateStr = itemData.end ? new Date(new Date(itemData.end) - 86400000).toLocaleDateString('en-GB', { month: 'numeric', day: 'numeric' }) : ''; // Trừ 1 ngày
        content += `<div class="phase-dates">${startDateStr} → ${endDateStr}</div>`;
    }
    return content;
  };

  const items  = new vis.DataSet((payload.items || []).map(it => {
    const className = (it.className || '') + ' phase' + (showDatesCheckbox.checked ? '' : ' hide-dates');
    return {
      ...it,
      className: className,
      content: createItemContent(it)
    }
  }));
  const itemsView = new vis.DataView(items);

  // --- Timeline options ---
  const options = {
    stack:false,
    margin:{ item:{ horizontal:0 } },
    template:(item)=> item.content,
    orientation:{ axis:'top' },
    showCurrentTime:true,
    selectable:false, moveable:false, zoomable:true,
    timeAxis:{ scale:'month', step:1 },
    format:{ minorLabels:{ month:'MMM' }, majorLabels:{ year:'YYYY' } },
    groupOrder:(a,b)=> (a.order||0)-(b.order||0)
  };
  const timeline = new vis.Timeline(container, itemsView, groups, options);

  // --- Helpers ---
  const getActiveGroupIds = () => Array.from(filterContainer.querySelectorAll('button.active[data-group-id]')).map(b=>parseInt(b.dataset.groupId));

  const saveActiveFilters = () => {
    try {
      const active = getActiveGroupIds();
      localStorage.setItem(LS_FILTER_KEY, JSON.stringify(active));
    } catch(_){}
  };

  const restoreActiveFilters = () => {
    try {
      const raw = localStorage.getItem(LS_FILTER_KEY);
      if (!raw) return false;
      const saved = JSON.parse(raw);
      if (!Array.isArray(saved)) return false;
      const btns = filterContainer.querySelectorAll('button[data-group-id]');
      if (!btns.length) return false;
      // set all inactive then activate saved
      btns.forEach(btn => {
        const gid = parseInt(btn.dataset.groupId, 10);
        if (saved.includes(gid)) btn.classList.add('active'); else btn.classList.remove('active');
      });
      return true;
    } catch(_) { return false; }
  };

  const computeBoundsFor = (groupIds) => {
    const arr = items.get({ filter: it => groupIds.includes(it.group) });
    if (!arr.length) return null;
    let min = null, max = null;
    for (const it of arr){
      const s = new Date(it.start);
      const e = new Date(it.end || it.start);
      if (!min || s < min) min = s;
      if (!max || e > max) max = e;
    }
    return {min, max};
  };

  const fitToActive = () => {
    const active = getActiveGroupIds();
    const bounds = computeBoundsFor(active);
    if (!bounds) { timeline.fit({animation:true}); return; }
    const pad = 30 * 24 * 3600 * 1000; // 30 days
    const start = new Date(bounds.min.getTime() - pad);
    const end   = new Date(bounds.max.getTime() + pad);
    timeline.setWindow(start, end, { animation:true });
  };
  // --- Auto fit when page becomes visible or on navigation ---
  const autoFitOnShow = () => {
    const ready = container && container.offsetParent !== null && container.clientWidth > 0 && container.clientHeight > 0;
    if (ready) {
      try { timeline.redraw(); } catch(e) {}
      fitToActive();
		if (items.length === 0) {
		  // Hiển thị một cửa sổ mặc định quanh “hôm nay” (±3 tháng)
		  const now = new Date();
		  const start = new Date(now.getFullYear(), now.getMonth() - 3, 1);
		  const end   = new Date(now.getFullYear(), now.getMonth() + 4, 0);
		  timeline.setWindow(start, end, { animation: true });
		  return;
		}
	  
    } else {
      requestAnimationFrame(autoFitOnShow);
    }
  };


  const applyFilterAndFit = () => {
    const active = getActiveGroupIds();
    const filteredGroups = groups.get({ filter: g => active.includes(g.id) });
    timeline.setGroups(filteredGroups);
    itemsView.setFilter(item => active.includes(item.group));
    const allBtn = filterContainer.querySelector('button.all-btn');
    const totalGroups = groups.get().length;
    allBtn.classList.toggle('active', active.length === totalGroups);
    saveActiveFilters();
    requestAnimationFrame(() => setTimeout(fitToActive, 60));
  };

  // --- Build filter buttons (VERTICAL) ---
  const allButton = document.createElement('button');
  allButton.className = 'list-group-item all-btn active';
  allButton.textContent = 'All';
  allButton.title = 'Chọn tất cả dự án';
  allButton.onclick = () => {
    filterContainer.querySelectorAll('button[data-group-id]').forEach(b => b.classList.add('active'));
    applyFilterAndFit();
  };
  filterContainer.appendChild(allButton);

  for (const g of groupsFromServer){
    const btn = document.createElement('button');
    btn.className = 'list-group-item active';
    btn.textContent = g.content;
    btn.dataset.groupId = g.id;
    btn.onclick = () => { btn.classList.toggle('active'); applyFilterAndFit(); };
    filterContainer.appendChild(btn);
  }

  // --- Drag reorder (VERTICAL) ---
  Sortable.create(filterContainer, {
    animation:150,
    filter:'.all-btn',
    direction:'vertical',
    onEnd: () => {
      const order = Array.from(filterContainer.children)
        .map(el => el.dataset.groupId)
        .filter(Boolean);
      localStorage.setItem(LS_ORDER_KEY, JSON.stringify(order));
      const map = new Map(order.map((id,i)=>[parseInt(id), i]));
      groups.get().forEach(g => groups.update({ id:g.id, order: map.get(g.id) ?? g.order }));
      const activeIds = getActiveGroupIds();
      timeline._setGroups(groups.get({ filter: g => activeIds.includes(g.id) }));
      requestAnimationFrame(() => setTimeout(fitToActive, 60));
    }
  });

  // --- Controls ---
  // View change buttons
  const viewBtns = document.querySelectorAll('.btn-group button[id^="view"]');
  const setView = (scale) => {
    timeline.setOptions({ timeAxis: { scale: scale, step: 1 } });
    viewBtns.forEach(btn => btn.classList.remove('active'));
    document.getElementById(`view${scale.charAt(0).toUpperCase() + scale.slice(1)}Btn`).classList.add('active');
  };
  document.getElementById('viewDayBtn').onclick = () => setView('day');
  document.getElementById('viewWeekBtn').onclick = () => setView('week');
  document.getElementById('viewMonthBtn').onclick = () => setView('month');
  
  document.getElementById('zoomInBtn').onclick  = () => timeline.zoomIn(0.5);
  document.getElementById('zoomOutBtn').onclick = () => timeline.zoomOut(0.5);
  document.getElementById('fitBtn').onclick     = () => fitToActive();
  document.getElementById('todayBtn').onclick   = () => timeline.moveTo(new Date());

  // Show Dates toggle
  showDatesCheckbox.addEventListener('change', () => {
      items.get().forEach(item => {
          const updatedContent = createItemContent(item);
          const newClassName = item.className.replace(' hide-dates', '').trim() + (showDatesCheckbox.checked ? '' : ' hide-dates');
          items.update({ id: item.id, content: updatedContent, className: newClassName });
      });
  });

  // Click item mở workspace dự án
  timeline.on('click', props => {
    const it = items.get(props.item);
    if (it && it.project_id){
      // Chuyển hướng đến workspace của project tương ứng
      window.location.href = `{{ url_for('main.project_workspace') }}?project_id=${it.project_id}`;
    }
  });

  // Save when leave page (backup an toàn)
  window.addEventListener('beforeunload', saveActiveFilters);

  // Re-fit on resize
  let resizeT; window.addEventListener('resize', () => { clearTimeout(resizeT); resizeT = setTimeout(fitToActive, 120); });

  // Initial: try restore; if không có thì giữ mặc định (all active)
  setTimeout(() => { 
    restoreActiveFilters(); 
    applyFilterAndFit();
  }, 150);
  // Auto-fit on page show / navigation / focus
  window.addEventListener('load', () => requestAnimationFrame(autoFitOnShow));
  window.addEventListener('pageshow', () => requestAnimationFrame(autoFitOnShow));
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') setTimeout(autoFitOnShow, 80);
  });
  window.addEventListener('focus', () => setTimeout(autoFitOnShow, 80));
  // One more after first render
  setTimeout(autoFitOnShow, 200);

  // Auto-fit on page show / navigation / focus
  window.addEventListener('load', () => requestAnimationFrame(autoFitOnShow));
  window.addEventListener('pageshow', () => requestAnimationFrame(autoFitOnShow));
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') setTimeout(autoFitOnShow, 80);
  });
  window.addEventListener('focus', () => setTimeout(autoFitOnShow, 80));
  // One more after first render
  setTimeout(autoFitOnShow, 200);

  
});
</script>
{% endblock %}
