{% extends "base.html" %}
{% block title %}Project Workspace{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/dhtmlxgantt/dhtmlxgantt.css') }}">


<style>
  :root { 
    --sidebar-width: 320px; 
  }
  .workspace-layout {
	display: block; 
  }
  .project-main { 
    padding-left: 0; 
  }
  .workspace-layout.sidebar-collapsed .project-sidebar {
    margin-left: calc(-1 * var(--sidebar-width));
    width: 0;
    padding: 0;
  }
  .workspace-layout.sidebar-collapsed .project-main {
    padding-left: 1.5rem;
  }
  .project-list-item { display: block; padding: .6rem .8rem; border-radius: .5rem; margin-bottom: .25rem; color: var(--bs-body-color); text-decoration: none; transition: background-color .2s; border: 1px solid transparent; }
  .project-list-item:hover { background-color: var(--bs-light-bg-subtle); }
  .project-list-item.active { background-color: var(--bs-primary-bg-subtle); color: var(--bs-primary-text-emphasis); border-color: var(--bs-primary-border-subtle); font-weight: 600; }
  .objective-block{background:#fff;border:1px solid #dee2e6;border-radius:.5rem;margin-bottom:1.5rem;box-shadow:0 1px 3px rgba(0,0,0,.05); transition: all 0.3s ease-in-out;}
  .objective-header{padding:1rem 1.25rem;color:#fff;display:flex;align-items:center;justify-content:space-between;cursor:pointer;background-image:linear-gradient(to bottom,var(--obj-color,#0d6efd),color-mix(in srgb,var(--obj-color,#0d6efd) 85%,black));border-top-left-radius:.5rem;border-top-right-radius:.5rem}
  .kr-container{padding:0 1.25rem 1.25rem 1.25rem}
  .kr-block{border-top:1px solid #f1f3f5;padding:1rem 0}
  .action-item{display:flex;justify-content:space-between;align-items:center;padding:.5rem 0}
  .action-text.done{text-decoration:line-through;color:#6c757d}
  .legend-badge{border-radius:.4rem;padding:.25rem .5rem;font-weight:600}
  .gantt_task_line.status_done{ opacity:.45; }
  .timeline-legend { display: none; } 
  /* === BẢNG MÀU CHÍNH CHO TIMELINE VÀ TRẠNG THÁI === */
:root {
    /* Bảng màu "Nóng & Năng động" */
    --project-color: #f97316;    /* Orange */
    --build-color: #44403c;      /* Stone */
    --objective-color: #0d9488;  /* Dark Teal */
    --key_result-color: #f59e0b; /* Amber */
    --task-color: #a8a29e;       /* Light Stone */

    /* Ánh xạ màu trạng thái (dùng chung cho cả sidebar và timeline) */
    --status-active-color: var(--objective-color); /* Teal for Active */
    --status-on-hold-color: var(--key_result-color);  /* Amber for On Hold */
    --status-done-color: var(--build-color);        /* Stone for Done */
    --status-planned-color: var(--task-color);      /* Light Stone for Planned */
}

/* === GIAO DIỆN DHTMLX GANTT === */
/* 1. Nâng cấp giao diện thanh task cho hiện đại hơn */
.gantt_task_line {
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-width: 0;
}
.gantt_task_progress {
    border-radius: 4px;
    opacity: 0.4;
}
.gantt_task_line.status_done { 
    opacity: .5;
}

/* 2. Áp dụng bảng màu mới cho các loại task */
.gantt_task_line.type-project { background-color: var(--project-color); }
.gantt_task_line.type-build { background-color: var(--build-color); }
.gantt_task_line.type-objective { background-color: var(--objective-color); }
.gantt_task_line.type-key_result { background-color: var(--key_result-color); }
.gantt_task_line.type-task { background-color: var(--task-color); }

/* === TRẠNG THÁI DỰ ÁN (Đồng bộ màu với Timeline) === */
/* Status Dots */
.status-Active { background-color: var(--status-active-color); }
.status-On\.Hold { background-color: var(--status-on-hold-color); }
.status-Done { background-color: var(--status-done-color); }
.status-Planned { background-color: var(--status-planned-color); }

/* Status Badges */
.status-badge-active {
    background-color: color-mix(in srgb, var(--status-active-color) 15%, #fff);
    color: color-mix(in srgb, var(--status-active-color) 80%, black);
    border-color: color-mix(in srgb, var(--status-active-color) 30%, #fff);
}
.status-badge-on-hold {
    background-color: color-mix(in srgb, var(--status-on-hold-color) 20%, #fff);
    color: color-mix(in srgb, var(--status-on-hold-color) 80%, black);
    border-color: color-mix(in srgb, var(--status-on-hold-color) 40%, #fff);
}
.status-badge-done {
    background-color: color-mix(in srgb, var(--status-done-color) 25%, #fff);
    color: #fff;
    border-color: color-mix(in srgb, var(--status-done-color) 40%, #fff);
}
.status-badge-planned {
    background-color: color-mix(in srgb, var(--status-planned-color) 20%, #fff);
    color: color-mix(in srgb, var(--status-planned-color) 80%, black);
    border-color: color-mix(in srgb, var(--status-planned-color) 40%, #fff);
}

/* Nút lọc trong timeline sẽ cần CSS riêng trong file _project_timeline_tab.html */
</style>
{% endblock %}

{% block content %}
<div class="workspace-layout">
  <main class="project-main">    
    {% if selected_project_data %}
<div class="d-flex align-items-center gap-4 px-3 py-2 border-bottom bg-body-tertiary rounded-top mb-4">
        <h4 class="m-0 text-primary fw-bold text-nowrap">{{ selected_project_data.project.name }}</h4>
        
        <ul class="nav nav-pills" id="projectTab" role="tablist">
          <li class="nav-item" role="presentation">
            <a class="nav-link {% if active_tab == 'info' %}active{% endif %}" href="{{ url_for('main.project_workspace', project_id=selected_project_id, tab='info') }}">Dashboard</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link {% if active_tab == 'okr' %}active{% endif %}" href="{{ url_for('main.project_workspace', project_id=selected_project_id, tab='okr') }}">OKR</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link {% if active_tab == 'timeline' %}active{% endif %}" href="{{ url_for('main.project_workspace', project_id=selected_project_id, tab='timeline') }}">Timeline</a>
          </li>
        </ul>

        <div class="ms-auto">
          <button class="btn btn-sm btn-outline-dark btn-edit-project" data-project-id="{{ selected_project_data.project.id }}">
            <i class="fa-solid fa-pen me-1"></i>Edit
          </button>
        </div>
      </div>

      <div class="tab-content" id="projectTabContent">
        <div class="tab-pane fade {% if active_tab == 'info' %}show active{% endif %}" role="tabpanel">
            {% set p_data = selected_project_data %}
            {% include 'partials/_project_info_tab.html' %}
        </div>
        <div class="tab-pane fade {% if active_tab == 'okr' %}show active{% endif %}" role="tabpanel">
            {% include 'partials/_project_okr_tab.html' %}
        </div>
        <div class="tab-pane fade {% if active_tab == 'timeline' %}show active{% endif %}" role="tabpanel">
           {% include 'partials/_project_timeline_tab.html' %}
        </div>
      </div>
    {% endif %}
  </main>
</div>

{% include 'partials/_project_modals.html' %}
{% include 'partials/_task_modal.html' %}
{% endblock %}

{% block scripts %}
{{ super() }}

<script src="{{ url_for('static', filename='vendor/dhtmlxgantt/dhtmlxgantt.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/sortablejs/Sortable.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/confetti/confetti.browser.min.js') }}"></script>


<script>
    window.SAVE_TASK_URL = "{{ url_for('main.save_task') }}";
    window.DELETE_TASK_URL_BASE = "{{ url_for('main.delete_task', task_id=0) }}".replace('/0', '/');
    window.UPDATE_TASK_TIME_URL = "{{ url_for('main.update_task_time') }}";
    window.UPLOAD_ATTACHMENT_URL = "{{ url_for('main.upload_attachment') }}";
    window.ADD_OBJECTIVE_URL = "{{ url_for('main.add_objective') }}";
    window.ADD_KEY_RESULT_URL = "{{ url_for('main.add_key_result') }}";
    window.UPDATE_ITEM_URL_BASE = "{{ url_for('main.update_okr_item', item_type='-', item_id=0) }}".replace('/-/0', '/');
    window.DELETE_ITEM_URL_BASE = "{{ url_for('main.delete_item', item_type='-', item_id=0) }}".replace('/-/0', '/');
    window.UPDATE_TASK_STATUS_URL_BASE = "{{ url_for('main.update_task_from_okr', task_id=0) }}".replace('/0', '/');
</script>
<script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
<script src="{{ url_for('static', filename='js/okr.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    const projectId = "{{ selected_project_id }}";
    const activeTab = "{{ active_tab }}";
    const toggleBtn = document.getElementById('sidebar-toggle-btn');
    const layout = document.querySelector('.workspace-layout');
    if(toggleBtn && layout) {
        const saveSidebarState = (isCollapsed) => localStorage.setItem('sidebarCollapsed', isCollapsed ? 'true' : 'false');
        const loadSidebarState = () => localStorage.getItem('sidebarCollapsed') === 'true';
        const applySidebarState = (isCollapsed) => {
            layout.classList.toggle('sidebar-collapsed', isCollapsed);
            const icon = toggleBtn.querySelector('i');
            icon.classList.toggle('fa-chevron-left', !isCollapsed);
            icon.classList.toggle('fa-chevron-right', isCollapsed);
        };
        applySidebarState(loadSidebarState());
        toggleBtn.addEventListener('click', function() {
            const isCollapsed = !layout.classList.contains('sidebar-collapsed');
            saveSidebarState(isCollapsed);
            applySidebarState(isCollapsed);
        });
    }
    // Logic cho các nút edit vẫn được giữ lại để có thể dùng ở nơi khác (ví dụ: nút edit trong tab info)
    document.body.addEventListener('click', async function(event) {
        const editProjectBtn = event.target.closest('.btn-edit-project');
        if (editProjectBtn) {
            const currentProjectId = editProjectBtn.dataset.projectId;
            const response = await fetch(`/api/project/${currentProjectId}`);
            if (!response.ok) return;
            const data = await response.json();
            const form = document.getElementById('editProjectForm');
            form.action = `/update-project/${currentProjectId}`;
            document.getElementById('editProjectName').value = data.name || '';
            document.getElementById('editProjectDescription').value = data.description || '';
            document.getElementById('editProjectStartDate').value = data.start_date || '';
            document.getElementById('editProjectEndDate').value = data.end_date || '';
            document.getElementById('editProjectStatus').value = data.status || 'Active';
			document.getElementById('editProjectOwner').value = data.owner_id || '';
            document.getElementById('editProjectNote').value = data.note || '';

            new bootstrap.Modal(document.getElementById('editProjectModal')).show();
        }
        const editBuildBtn = event.target.closest('.btn-edit-build');
        if (editBuildBtn) {
            const buildId = editBuildBtn.dataset.buildId;
            const response = await fetch(`/api/build/${buildId}`);
            if (!response.ok) return;
            const data = await response.json();
            const form = document.getElementById('editBuildForm');
            form.action = `/update-build/${buildId}`;
            document.getElementById('editBuildName').value = data.name || '';
            document.getElementById('editBuildProject').value = data.project_id || '';
            document.getElementById('editBuildStartDate').value = data.start_date || '';
            document.getElementById('editBuildEndDate').value = data.end_date || '';
            document.getElementById('editBuildScheduleLink').value = data.schedule_link || ''; 
			document.getElementById('editBuildOwner').value = data.owner_id || '';
            document.getElementById('editBuildNote').value = data.note || '';
            
            new bootstrap.Modal(document.getElementById('editBuildModal')).show();
        }
    });
    if (activeTab === 'okr') {
        const okrContent = document.getElementById('okr-tab-content');
		if (okrContent) {
			okrContent.addEventListener('change', function(event) {
				if (event.target.matches('.task-checkbox')) {
					const checkbox = event.target;
					const taskId = checkbox.dataset.id;
					const isChecked = checkbox.checked;
					const url = window.UPDATE_TASK_STATUS_URL_BASE + taskId;

					fetch(url, { 
						method: 'POST', 
						headers: { 'Content-Type': 'application/json' }, 
						body: JSON.stringify({ checked: isChecked }) 
					})
					.then(res => res.json())
					.then(data => {
						if (data.success) {
							const actionItem = checkbox.closest('.action-item');
							actionItem.querySelector('.action-text').classList.toggle('done', isChecked);

							const krBlock = actionItem.closest('.kr-block');
							const krProgressBar = krBlock.querySelector(`#kr-progress-bar-${data.kr_id}`);
							const krProgressText = krBlock.querySelector(`#kr-progress-text-${data.kr_id}`);

							if(krProgressBar) krProgressBar.style.width = `${data.kr_progress}%`;
							if(krProgressText) krProgressText.textContent = `${data.kr_current.toFixed(1)}/${data.kr_target.toFixed(1)}`;

							const objBlock = krBlock.closest('.objective-block');
							const objProgressBar = objBlock.querySelector(`#obj-progress-bar-${data.objective_id}`);
							const objProgressText = objBlock.querySelector(`#obj-progress-text-${data.objective_id}`);
							const objHeaderProgress = objBlock.querySelector('.objective-header .badge');

							if(objProgressBar) objProgressBar.style.width = `${data.obj_progress}%`;
							if(objProgressText) objProgressText.textContent = `${Math.round(data.obj_progress)}%`;
							if(objHeaderProgress) objHeaderProgress.textContent = `${data.obj_progress.toFixed(1)}%`;

							if (isChecked) {
								const rect = checkbox.getBoundingClientRect();
								const origin = {
									x: (rect.left + rect.right) / 2 / window.innerWidth,
									y: (rect.top + rect.bottom) / 2 / window.innerHeight
								};
								confetti({
									particleCount: 100,
									spread: 70,
									origin: origin
								});
							}

						} else { 
							checkbox.checked = !isChecked; 
							alert(data.message || "An error occurred.");
						}
					}).catch((err) => { 
						checkbox.checked = !isChecked; 
						console.error("Fetch Error:", err);
						alert("Could not connect to the server.");
					});
				}
			});
		}
        const okrFilterControls = document.getElementById('okrFilterControls');
        if (okrFilterControls) {
            okrFilterControls.addEventListener('click', function(e) {
                const button = e.target.closest('button');
                if (!button) return;
                okrFilterControls.querySelector('.active')?.classList.remove('active');
                button.classList.add('active');
                const filterStatus = button.dataset.status;
                document.querySelectorAll('#okr-tab-content .objective-block').forEach(block => {
                    if (filterStatus === 'all') { block.style.display = ''; return; }
                    const progress = parseInt(block.querySelector('[id^="obj-progress-text-"]').textContent) || 0;
                    let shouldShow = (filterStatus === 'done' && progress === 100) || (filterStatus === 'processing' && progress > 0 && progress < 100) || (filterStatus === 'pending' && progress === 0);
                    block.style.display = shouldShow ? '' : 'none';
                });
            });
        }
        const objectiveListContainer = document.getElementById('objective-list-container');
        if (objectiveListContainer) {
            new Sortable(objectiveListContainer, {
                animation: 150, handle: '.objective-header', ghostClass: 'bg-info-subtle',
                onEnd: function (evt) {
                    const newOrderIds = Array.from(objectiveListContainer.children).map(block => block.dataset.objId).filter(id => id);
                    fetch('/api/objectives/update-order', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ order: newOrderIds }) });
                }
            });
        }
    }
	if (activeTab === 'timeline' && projectId) {
        if (gantt.plugins) {
			gantt.plugins({ marker: true, tooltip: true });
		}

		gantt.config.layout = {
			css: "gantt_container",
			rows: [ { cols: [ { view: "grid", scrollY: "scrollVer" }, { resizer: true, width: 1 }, { view: "timeline", scrollX: "scrollHor", scrollY: "scrollVer" }, { view: "scrollbar", id: "scrollVer" } ] }, { view: "scrollbar", id: "scrollHor", height: 20 } ]
		};
        
        gantt.config.autofit = false;
        gantt.config.grid_resize = true;
        gantt.config.min_column_width = 40; 
		gantt.config.grid_width = 620;

        const dateToStr = gantt.date.date_to_str("%d-%m-%y");
		gantt.config.columns = [
			{ name: "text", label: "Work Item", tree: true, resize: true, min_width: 250 }, 
			{ name: "start_date", label: "Start", align: "center", resize: true, width: 100, template: (task) => dateToStr(task.start_date) },
			{ name: "end_date", label: "End", align: "center", resize: true, width: 100, template: (task) => {
                const endDate = new Date(task.end_date);
                endDate.setDate(endDate.getDate() - 1);
                return dateToStr(endDate);
            }},
			{ name: "assignee_name", label: "Assignee", align: "center", resize: true, width: 100, template: t => t.assignee_name || "" },
			{ name: "progress", label: "%", align: "center", resize: true, width: 60, template: t => Math.round((t.progress || 0) * 100) + "%" }
		];
		gantt.config.date_format = "%Y-%m-%d";
		
		gantt.ext.zoom.init({
			levels: [
				{ name: "year", scale_height: 75, scales: [
                    { unit: "year", step: 1, format: "%Y" },
                    { unit: "quarter", step: 1, format: date => {
                        const month = date.getMonth();
                        if (month < 3) return "Q1";
                        if (month < 6) return "Q2";
                        if (month < 9) return "Q3";
                        return "Q4";
                    }},
                    { unit: "month", step: 1, format: "%M" }
                ]},
				{ name: "month", scale_height: 75, scales: [
                    { unit: "year", step: 1, format: "%Y" },
                    { unit: "month", step: 1, format: "%F" }, 
                    { unit: "week", step: 1, format: d => "W" + gantt.date.getWeek(d) }
                ]},
				{ name: "week", scale_height: 90, scales: [
                    { unit: "year", step: 1, format: "%Y" },
                    { unit: "week", step: 1, format: d => "W" + gantt.date.getWeek(d) },
                    { unit: "day", step: 1, format: "%D" },
                    { unit: "day", step: 1, format: "%d" }
                ]}
			]
		});
		gantt.ext.zoom.setLevel("week");
		gantt.templates.task_class = (s, e, t) => `type-${t.type} ${ (t.progress||0) >= 1 ? 'status_done' : '' }`;
		gantt.templates.tooltip_text = (s, e, t) => `<b>${t.text}</b><br/>Progress: ${Math.round((t.progress||0)*100)}%`;
		
        gantt.attachEvent("onGanttReady", function () {
            const legend = document.querySelector(".timeline-legend");
            if(legend) legend.style.display = "flex";
        });
		gantt.init("gantt_here");
		gantt.addMarker({ start_date: new Date(), css: "today", text: "Today" });
		gantt.attachEvent("onTaskClick", function(id, e) {
			if (e.target.closest(".gantt_tree_icon")) return true;
			const task = gantt.getTask(id);
			if (task.type === 'task') {
				e.preventDefault();
				const realTaskId = String(task.id).replace('task-', '');
				fetch(`/api/task/${realTaskId}`).then(res => res.json()).then(data => { if (data.success && typeof window.openEditModal === 'function') { window.openEditModal(data.task); } });
				return false;
			}
			return true;
		});
		let ownerFilterValue = "", showDone = true, searchQuery = "";
		let visibleTypes = new Set(["project", "build", "objective", "key_result", "task"]); 
		gantt.attachEvent("onBeforeTaskDisplay", (id, t) => {
			if (!visibleTypes.has(t.type)) return false; 
			if (ownerFilterValue && (t.owner || "") !== ownerFilterValue) return false;
			if (!showDone && (t.progress || 0) >= 1) return false;
			if (searchQuery && !(t.text || "").toLowerCase().includes(searchQuery)) return false;
			return true;
		});
        const toolbar = document.querySelector("#projectTabContent .tab-pane.active header");
		document.getElementById('btnToday')?.addEventListener('click', () => gantt.showDate(new Date()));
        document.getElementById('btnFit')?.addEventListener('click', () => {gantt.config.fit_tasks = true; gantt.render();});
		document.getElementById('ownerFilter')?.addEventListener('change', e => { ownerFilterValue = e.target.value || ""; gantt.refreshData(); });
		document.getElementById('toggleDone')?.addEventListener('change', e => { showDone = e.target.checked; gantt.refreshData(); });
		let searchTimeout; 
        document.getElementById('ganttSearch')?.addEventListener('input', e => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { searchQuery = (e.target.value || '').toLowerCase().trim(); gantt.refreshData(); }, 300); });
		const typeFilter = document.getElementById('ganttTypeFilter');
		if (typeFilter) {
			typeFilter.addEventListener('click', (e) => {
				const button = e.target.closest('button');
				if (!button) return;

				const type = button.dataset.type;
				const allButtons = typeFilter.querySelectorAll('button[data-type]');

				if (type === 'all') {
					const shouldBeActive = !allButtons[0].classList.contains('active');
					allButtons.forEach(btn => {
						btn.classList.toggle('active', shouldBeActive);
						const btnType = btn.dataset.type;
						if (btnType !== 'all') {
							shouldBeActive ? visibleTypes.add(btnType) : visibleTypes.delete(btnType);
						}
					});
				} else {
					button.classList.toggle('active');
					if (visibleTypes.has(type)) {
						visibleTypes.delete(type);
					} else {
						visibleTypes.add(type);
					}
					const allActive = typeFilter.querySelectorAll('button[data-type]:not([data-type="all"]).active').length === 5;
					typeFilter.querySelector('button[data-type="all"]').classList.toggle('active', allActive);
				}
				gantt.refreshData();
			});
		}        
		const zoomButtons = toolbar.querySelector(".btn-group[role='group']");
        if(zoomButtons) { zoomButtons.addEventListener('click', e => { if(e.target.tagName !== 'BUTTON') return; const level = e.target.textContent.toLowerCase(); if (['year','month','week'].includes(level)) gantt.ext.zoom.setLevel(level); if (e.target.textContent === '+') gantt.ext.zoom.zoomIn(); if (e.target.textContent === '-') gantt.ext.zoom.zoomOut(); }); }
		gantt.load(`/api/dhtmlx-data?project_id=${projectId}`).then(() => {
            const owners = new Set();
			gantt.eachTask(t => { if (t.owner) owners.add(t.owner); });
            const ownerSelect = document.getElementById('ownerFilter');
			if (ownerSelect) {
                ownerSelect.innerHTML = '<option value="">All assignees</option>'; 
                owners.forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; ownerSelect.appendChild(opt); });
            }
            gantt.render();
        });
	}
});
</script>
{% endblock %}
